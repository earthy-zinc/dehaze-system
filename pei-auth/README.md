# `pei-auth`包的作用
`pei-auth`是认证授权中心模块，主要负责处理系统的用户认证（登录）和权限控制。它是整个微服务架构中安全管理的核心组件，通过提供统一的认证和鉴权服务，确保其他服务能够安全地进行访问控制。

## 主要功能

1. **用户认证**
    - 处理用户的登录请求。
    - 验证用户名和密码是否正确。
    - 生成并返回认证令牌（如JWT），供后续接口调用使用。

2. **权限管理**
    - 管理用户的角色和权限。
    - 在用户访问资源时，验证其是否有相应的权限。

3. **验证码生成与校验**
    - 提供图形验证码或短信验证码功能，防止暴力破解攻击。

4. **集成Dubbo**
    - 使用Dubbo框架实现服务间的远程调用，便于与其他微服务交互。

5. **配置管理**
    - 利用Nacos进行配置管理，动态加载公共配置和模块专属配置。

6. **日志记录**
    - 记录认证过程中的关键操作日志，便于审计和问题追踪。

7. **异常处理**
    - 统一处理认证和鉴权过程中发生的异常，并返回友好的错误信息。


## 功能实现分析

### 1. 用户认证流程
- 用户提交登录请求（用户名、密码、验证码等）。
- 控制器层接收请求，将参数传递给服务层。
- 服务层验证用户信息，如果正确，则生成JWT令牌。
- 返回令牌给客户端，客户端后续请求需携带该令牌进行访问。

### 2. 权限控制
- 使用Spring Security或Sa-Token等框架进行权限控制。
- 每个接口通过注解（如`@PreAuthorize`）定义访问权限。
- 在请求到达业务逻辑前，系统会检查用户是否有足够的权限。

### 3. 验证码生成
- 使用工具类生成图片验证码或短信验证码。
- 验证码存储在Redis中，设置过期时间，防止重复使用。

### 4. Dubbo集成
- 使用`@EnableDubbo`注解启用Dubbo服务。
- 通过Dubbo调用其他服务（如用户服务、权限服务）获取数据。

### 5. Nacos配置管理
- 在 application.yml 中配置Nacos地址和命名空间。
- 从Nacos加载共享配置（如数据库连接、Redis配置）和服务专属配置。


## 内部代码架构

### 整体包结构
```
com.pei.auth
├── captcha        // 验证码相关功能
├── config         // Spring Boot配置类
├── controller     // 控制器层，处理HTTP请求
├── domain         // 数据传输对象（DTO）
├── enums          // 枚举类
├── form           // 表单数据封装类
├── listener       // 事件监听器
├── properties     // 配置属性绑定类
├── service        // 业务逻辑层
└── PeiAuthApplication.java // 启动类
```

### `captcha` 包（验证码相关功能）
#### UnsignedMathGenerator.java
- **作用**：生成数学类型的验证码（例如“12 + 34 =”）。
- **实现方式**：
    - 使用随机数生成两个整数，并随机选择一个运算符（+、-、*）。
    - 返回格式为“xx op xx=”的字符串，供用户输入答案。
- **方法**：
    - `generate()`：生成验证码字符串。
    - `verify(String code, String userInputCode)`：验证用户输入是否正确。
    - `getLength()`：返回验证码长度。

#### CaptchaConfig.java
- **作用**：配置不同类型的验证码生成器（如圆形、线段、扭曲干扰）。
- **实现方式**：
    - 使用Spring的`@Bean`注解创建不同的验证码对象（`CircleCaptcha`, `LineCaptcha`, `ShearCaptcha`）。
    - 设置通用样式（背景色、字体等）。
- **关键类**：
    - `CircleCaptcha`：圆圈干扰验证码。
    - `LineCaptcha`：线段干扰验证码。
    - `ShearCaptcha`：扭曲干扰验证码。


### `controller` 包（控制器层，处理HTTP请求）
#### CaptchaController.java
- **作用**：提供获取验证码的REST接口。
- **实现方式**：
    - 通过反射动态创建验证码生成器。
    - 生成Base64编码的图片验证码并存储到Redis中。
- **关键方法**：
    - getCode()：返回验证码信息（包括UUID和Base64图片）。
    - getCodeImpl()：实际生成验证码的方法，受限流控制。

#### TokenController.java
- **作用**：处理用户的登录、登出、注册、第三方登录等功能。
- **实现方式**：
    - 使用Sa-Token进行用户身份认证和权限管理。
    - 支持多种登录方式（密码登录、短信登录、邮箱登录、社交登录等）。
    - 与远程服务交互（如用户服务、租户服务、客户端服务等）。
- **关键方法**：
    - login(LoginBody loginBody)：处理登录请求，返回令牌。
    - logout()：处理登出请求。
    - register(RegisterBody registerBody)：处理用户注册。
    - socialCallback(SocialLoginBody loginBody)：处理第三方登录回调。

---

### `domain` 包（数据传输对象 DTO）
#### `vo.LoginVo.java`
- **作用**：封装登录成功后返回的令牌信息。

### `enums` 包（枚举类）
#### CaptchaType.java
- **作用**：定义支持的验证码类型（数字、字符）。


#### CaptchaCategory.java
- **作用**：定义验证码的干扰类型（线段、圆圈、扭曲）。

### `form` 包（表单数据封装类）
#### PasswordLoginBody.java
- **作用**：封装密码登录请求的数据。
- **校验规则**：
    - 用户名不能为空，且长度在2~30之间。
    - 密码不能为空，且长度在5~30之间。

### `listener` 包（事件监听器）
#### UserActionListener.java
- **作用**：监听用户登录、登出、被踢下线等行为。
- **实现方式**：
    - 实现`SaTokenListener`接口，监听Sa-Token的事件。
    - 记录登录日志、更新在线用户状态。
- **关键方法**：
    - doLogin(...)：用户登录时记录相关信息。
    - doLogout(...)：用户登出时清理缓存。
    - doKickout(...)：用户被踢下线时清理缓存。

### `properties` 包（配置属性绑定类）
#### CaptchaProperties.java
- **作用**：从配置文件中读取验证码相关的配置。

### `service` 包（业务逻辑层）
#### SysLoginService.java
- **作用**：处理登录、登出、注册、验证码校验等核心业务逻辑。
- **实现方式**：
    - 使用Dubbo调用远程服务（如用户服务、租户服务等）。
    - 使用Redis缓存验证码和用户登录信息。

#### IAuthStrategy.java
- **作用**：定义认证策略接口，支持多种认证方式（如密码认证、短信认证等）。
- **实现方式**：
    - 使用策略模式，根据授权类型动态选择对应的实现类。

### 技术栈
- **Spring Boot**: 快速构建微服务应用。
- **Spring Security / Sa-Token**: 实现认证和权限控制。
- **JWT**: 用于生成和解析令牌。
- **Dubbo**: 服务间通信。
- **Nacos**: 配置中心和服务注册发现。
- **Redis**: 存储验证码和会话信息。
- **MyBatis Plus**: 数据库操作（如果有数据库依赖）。

### 关键类说明
- `PeiAuthApplication`: 应用启动类，包含`main`方法。
- `CaptchaController`: 处理验证码生成和校验。
- `LoginController`: 处理用户登录请求。
- `AuthService`: 核心认证业务逻辑，包括生成令牌、校验用户等。
- `JwtUtil`: JWT工具类，负责生成和解析令牌。
- SecurityConfig: Spring Security配置类，定义安全策略。

### 总结
`pei-auth`模块通过清晰的分层架构实现了完整的认证和授权功能。
`pei-auth`模块作为认证授权中心，承担了用户认证、权限管理和安全控制的核心职责。它采用分层架构设计，结合Spring Boot、Dubbo、Nacos等技术，实现了高内聚、低耦合的设计目标。同时，通过验证码、JWT、权限注解等方式增强了系统的安全性。
其核心流程如下：

1. **验证码生成与校验**：
    - 使用Hutool生成各种类型的验证码。
    - 验证码存储在Redis中，设置过期时间。

2. **用户登录**：
    - 支持多种登录方式（密码、短信、邮箱、社交等）。
    - 登录成功后生成JWT令牌，返回给客户端。

3. **权限管理**：
    - 使用Sa-Token进行权限控制。
    - 提供丰富的监听器，记录用户行为。

4. **安全增强**：
    - 登录失败次数限制，防止暴力破解。
    - 使用BCrypt加密用户密码。
