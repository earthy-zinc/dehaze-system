---
order: 5
---

# 系统部署
## 操作系统环境搭建
### docker搭建

#### 安装docker

使用官方给出的脚本，https://get.docker.com/

```shell
# 获取并运行安装脚本
curl -fsSL get.docker.com -o get-docker.sh
sudo sh get-docker.sh
# 启动docker服务
systemctl start docker
# 配置docker开机自启
systemctl enable docker
```

#### 配置国内镜像

修改配置文件

```shell
sudo vim /etc/docker/daemon.json
```

添加内容

```json
{
  "registry-mirrors":[
                      "https://o65lma2s.mirror.aliyuncs.com",
                      "http://hub-mirror.c.163.com"
                     ],
  "insecure-registries" :  ["192.168.210.100:5000"]
}
```

重启docker

```shell
systemctl daemon-reload && systemctl restart docker
```

#### 注意事项

如果以非 root 用户可以运行 docker 时，
需要执行 `sudo usermod -aG docker cmsblogs` 命令然后重新登陆，
否则会有如下报错

```md
docker: Cannot connect to the Docker daemon. 
Is the docker daemon running on this host ?
```

### mysql搭建

```bash
docker run --restart=always \
-d \
-p 3307:3306 \
--privileged=true \
-v /opt/docker_volume/mysql/log:/var/log/mysql \
-v /opt/docker_volume/mysql/data:/var/lib/mysql \
-v /opt/docker_volume/mysql/conf:/etc/mysql/conf.d \
-e MYSQL_ROOT_PASSWORD=123456 \
--name mysql \
mysql
```

### redis搭建

官网获取 `redis.conf` : http://www.redis.cn/download.html

```shell
mkdir -p /opt/docker_volume/redis
```



解压后可在根目录查看到 `redis.conf` 配置文件，将其内容复制到 `/opt/docker_volume/redis/redis.conf`，然后修改以下内容：

- bind 127.0.0.1 ： 注释掉，redis可以外部访问
- --requirepass "123456" ： 设置Redis密码为123456，默认无密码
- --appendonly yes ： AOF持久化
- tcp-keepalive 60 ： 默认300，调小防止远程主机强迫关闭一个现有连接错误

```bash
docker run --restart=always \
--log-opt max-size=100m \
--log-opt max-file=2 \
-p 6379:6379 \
--name redis \
-v /opt/docker_volume/redis/redis.conf:/etc/redis/redis.conf \
-v /opt/docker_volume/redis/data:/data \
-d redis redis-server /etc/redis/redis.conf  \
--appendonly yes  \
--requirepass 142536aA
```

### nginx搭建

#### 创建临时容器

启动前需要先创建Nginx外部挂载的配置文件，之所以要先创建 , 是因为Nginx本身容器只存在/etc/nginx 目录 , 本身就不创建 nginx.conf 文件
当服务器和容器都不存在 nginx.conf 文件时, 执行启动命令的时候 docker会将nginx.conf 作为目录创建 , 这并不是我们想要的结果 。

（ /home/nginx/conf/nginx.conf）

```bash
# 创建挂载目录
mkdir -p /opt/docker_volume/nginx/conf && mkdir -p /opt/docker_volume/log && mkdir -p /opt/docker_volume/nginx/html
  # 或
sudo mkdir -p /home/earthyzinc/nginx/conf && sudo mkdir -p /home/earthyzinc/nginx/log && sudo mkdir -p /home/earthyzinc/nginx/html
# 创建文件
touch /opt/docker_volume/nginx/conf/nginx.conf
# 生成容器
docker run --name nginx -p 9527:80 -d nginx
# 将容器nginx.conf文件, conf.d文件夹下内容, html文件夹复制到宿主机
docker cp nginx:/etc/nginx/nginx.conf /opt/docker_volume/nginx/conf/nginx.conf

docker cp nginx:/etc/nginx/conf.d /opt/docker_volume/nginx/conf/conf.d

docker cp nginx:/usr/share/nginx/html /opt/docker_volume/nginx
# 删除临时容器
docker rm -f nginx
```

#### 创建和启动容器
创建容器互联网络
```shell
docker network create -d bridge earthy-net
```

```bash
docker run --restart=always \
--name nginx \
-p 9531:9531 \
-p 9532:9532 \
-v /opt/docker_volume/nginx/conf/nginx.conf:/etc/nginx/nginx.conf \
-v /opt/docker_volume/nginx/conf/conf.d:/etc/nginx/conf.d \
-v /opt/docker_volume/nginx/log:/var/log/nginx \
-v /opt/docker_volume/nginx/html:/usr/share/nginx/html \
-d nginx

docker run --restart=always \
--name nginx \
--network host \
-v /home/earthyzinc/nginx/conf/nginx.conf:/etc/nginx/nginx.conf \
-v /home/earthyzinc/nginx/conf/conf.d:/etc/nginx/conf.d \
-v /home/earthyzinc/nginx/log:/var/log/nginx \
-v /home/earthyzinc/nginx/html:/usr/share/nginx/html \
-v /home/earthyzinc/nginx/ssl:/usr/share/nginx/ssl \
-d nginx
```

* -v /opt/docker_volume/nginx/conf/nginx.conf:/etc/nginx/nginx.conf	挂载nginx.conf配置文件
* -v /opt/docker_volume/nginx/conf/conf.d:/etc/nginx/conf.d	挂载nginx配置文件
* -v /opt/docker_volume/nginx/log:/var/log/nginx	挂载nginx日志文件
* -v /opt/docker_volume/nginx/html:/usr/share/nginx/html	挂载nginx内容

## 代码运行环境搭建

## 持续集成部署流程

## 运行情况检查

