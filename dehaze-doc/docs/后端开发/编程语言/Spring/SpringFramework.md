---
order: 1
---

# Spring FrameWork

## 1、`IoC`容器

### 1）容器的概念

对于一个可以存放数据的具体数据结构的实现，都可以叫做容器。spring 的容器是为某些特定组件对象提供必要支持的一个软件环境。这些特定的组件对象就是 Spring
Bean，他提供了一些底层服务如对象的配置、对象整个生命流程的管理，让容器所承载的对象不必在考虑这些问题。Tomcat 就是一个 Servlet 容器，底层实现了 TCP 连接，解析 HTTP 协议等非常复杂的服务。我们自己就无需在组件中编写这些复杂的逻辑。IoC 容器它可以管理所有轻量级的 JavaBean 组件，提供的底层服务包括组件的生命周期管理、配置和组装服务、AOP 支持，以及建立在 AOP 基础上的声明式事务服务等。

如果把一个 Bean 对象交给 Spring 容器管理。这个对象会被拆解存放到 Bean 的定义中。然后在由 Spring 统一装配，在装配中包括 Bean 的初始化、属性填充。对于 Spring 容器，我们需要一种可以用于存放对象、可以通过名称索引查找对象的数据结构，那么我们选择 HashMap。Spring 容器的实现需要对象的定义、注册、获取三个基本步骤。

- 定义：定义存放在 Spring 中的对象，这里我们把这种对象称为 bean 对象。因此这个定义的过程称为 BeanDefinition。我们设计他是一个类。里面包含 singleton、prototype、BeanClassName 等属性。
- 注册：将 Bean 对象注册到 Spring 容器中，或者称为将对象放入 HaspMap 中以便我们后续的获取。Key 为 Bean 对象的名称，Value 为对象本身。
- 获取：通过 Bean 对象的名称可以获取该对象。

### 2）容器的设计

Spring 中 Bean 对象的创建是交给容器本身来完成的，而不是我们在调用是传入一个已经实例化的对象。对于同一个类型的对象，有时我们需要一个有时需要多个，那么我们需要重点考虑的是单例对象。

### 2）控制反转 IoC

`IoC`意为控制反转（Inversion of Control），对程序中对象的创建、配置这样的控制权由应用程序转移到了 `IoC`
容器，那对于某个具体的实例对象它的所有组件对象不再由应用程序自己创建和配置，而是通过 `IoC`容器负责。这样应用程序能够直接使用已经创建并配置好的组件。

在设计上 `IoC`
容器是一个无侵入的容器，应用程序的组件无需实现 Spring 的特定接口，那么这些组件即可以在 spring 容器中运行，又能够自己编写代码组装他所需要的对象。还有就是在测试的时候，也就不需要实现接口，不依赖与 Spring 容器，可单独测试。

### 3）依赖注入

这些组件需要通过注入机制来装入到实例对象中，供实例对象使用。依赖注入的方式可以有两种，一种是通过 `setXXX()`方法注入，另一种是通过构造方法实现。Spring 的 IoC 容器同时支持属性注入和构造方法注入，并允许混合使用。

因为 `IoC`容器需要负责实例化所有组件对象，所以需要告诉容器如何创建组件对象，以及各个组件对象之间的依赖关系，即装配方式。在 Spring 可以通过两种方式实现，一种是 XML 配置文件，另一种是通过注解。

### 4）组件装配

#### I 通过 XML 装配组件

我们需要自己将组件之间的依赖关系描述出来，然后交给容器来创建并装配。

**第一步 编写配置文件 application.xml**

我们需要编写一个特定的名叫 application 的配置文件 `application.xml`告诉 Spring 容器应该如何创建、并按顺序正确的注入到相应的组件中。Bean 表示这是一个 Java Bean 或者说是一个组件。id 唯一标识了一个 Java Bean，class 提供了文件路径。每个 Java Bean 内部可以有一个或多个需要注入的属性，以 property 标签表示。而这些属性也是一个 Java Bean，name 表示在这个组件内部这个需要注入的属性的名称是什么。ref 表示这个需要注入的属性所指向的 Java Bean 的 id。这些 Java Bean 在配置文件的相对位置并不重要，但是每个组件中要注入的属性需要写全，不写全的画 spring 会漏掉注入该属性。如果注入的不是 Java Bean 那么将 ref 改为 value。

总结来说，Java Bean 通过引用注入，数据类型通过 value 注入。

```xml
<bean id="userService" class="com.itranswarp.learnjava.service.UserService">
    <property name="mailService" ref="mailService" />			<!--引用注入-->
    <property name="username" value="root" />				    <!--值注入-->
    <property name="password" value="password" />
</bean>
```

**第二步 在代码中加载配置文件**

我们需要创建一个 `Spring IoC`容器的实例，然后加载配置文件。接下来我们就可以从 Spring 容器中取出组件并使用它。Spring 容器命名为应用程序上下文，就是 `ApplicationContext`，它是一个接口，用来加载配置文件，有很多实现类。通过 xml 加载需要 `ClassPathXmlApplicationContext`实现类来帮我们自动从项目路径下查找指定的配置文件，参数为配置文件名。通过注解加载需要 `AnnotationConfigApplicationContext`实现类，参数为配置类名称，必须传入一个标注了 `@Configuration`的类名。。

#### II 通过注解装配组件

见组件详解

## 2、AOP

在实际开发中有很多功能是许多组件通用的，但又是非核心的业务逻辑。让框架把一些很多个不同的组件之间通用的非核心的业务逻辑通过某种方法，织入到组件中。那么 AOP 要把切面即一些非核心、但又必要的逻辑织入核心逻辑中，我们在调用某个业务方法时，spring 会对该方法进行拦截，并在拦截前后进行安全检查、日志、事务等处理。从而完成了整个业务流程。有 3 种方式实现。

- 编译期，由编译器把切面（非核心的逻辑）编译进字节码。
- 类加载器：当目标被装载到 JVM 时，通过一个特殊的类加载器，对目标类的字节码重新增强
- 运行期：通过动态代理实现运行期动态织入。

Spring 的 AOP 实现就是基于 JVM 的动态代理，通过 AOP 技术，可以让我们把一些常用的功能如权限检查、日志、事务等，从每个业务方法中剥离出来。

我们使用 AOP 非常简单，一共需要三步：

1. 定义切入方法，并在方法上通过 AspectJ 的注解告诉 Spring 应该在何处调用此方法；
2. 在需要切入方法的地方标记 `@Component`和 `@Aspect`；
3. 在 `@Configuration`类上标注 `@EnableAspectJAutoProxy`。

我们还可以通过自定义注解来切入功能。在那些需要切入这种常用的功能的方法头上，标记一个自定义注解，而在切入方法（常用的功能逻辑所在的方法）的 AOP 注解参数中填入该注解的名称，参数格式为 `"@annotation(your_annotation_name)"`，那么只要标注了你自定义注解的地方，spring 都会把切入方法切入到里面。
